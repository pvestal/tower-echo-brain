<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Brain Console</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'SF Mono', Consolas, 'Liberation Mono', monospace;
            background: #0d1117;
            color: #f0f6fc;
            line-height: 1.4;
        }

        .header {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 12px 20px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .header h1 {
            color: #58a6ff;
            font-size: 18px;
            font-weight: normal;
        }

        .header .status {
            margin-left: auto;
            font-size: 12px;
            color: #7d8590;
        }

        .container {
            display: grid;
            grid-template-columns: 250px 1fr 280px;
            height: calc(100vh - 60px);
            gap: 1px;
        }

        .panel {
            background: #161b22;
            border-right: 1px solid #30363d;
            overflow-y: auto;
        }

        .panel h2 {
            background: #21262d;
            padding: 8px 12px;
            font-size: 12px;
            color: #7d8590;
            text-transform: uppercase;
            font-weight: normal;
            border-bottom: 1px solid #30363d;
        }

        .content {
            padding: 12px;
        }

        .log-line {
            font-size: 11px;
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-line.error { color: #f85149; }
        .log-line.warn { color: #d29922; }
        .log-line.info { color: #79c0ff; }
        .log-line.success { color: #3fb950; }

        .search-box {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 6px 8px;
            font-size: 11px;
            margin-bottom: 8px;
            font-family: inherit;
        }

        .search-box:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .memory-result {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 8px;
            margin: 4px 0;
            font-size: 10px;
            border-radius: 3px;
        }

        .memory-score {
            color: #3fb950;
            font-weight: bold;
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 11px;
        }

        .service-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .service-status.up { background: #3fb950; }
        .service-status.down { background: #f85149; }
        .service-status.unknown { background: #d29922; }

        .pipeline-item {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 6px 8px;
            margin: 2px 0;
            font-size: 10px;
        }

        .pipeline-status {
            color: #7d8590;
            float: right;
        }

        .pipeline-status.running { color: #79c0ff; }
        .pipeline-status.complete { color: #3fb950; }
        .pipeline-status.failed { color: #f85149; }

        .btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            font-family: inherit;
            margin: 2px;
        }

        .btn:hover {
            background: #30363d;
        }

        .approval-item {
            background: #0d1117;
            border-left: 3px solid #d29922;
            padding: 6px 8px;
            margin: 4px 0;
            font-size: 10px;
        }

        .approval-item.urgent {
            border-left-color: #f85149;
        }

        .timestamp {
            color: #7d8590;
            font-size: 9px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
        }

        .log-viewer {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 8px;
            overflow-y: auto;
            font-size: 10px;
        }

        .chat-history {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #30363d;
            background: #0d1117;
            padding: 8px;
        }

        .chat-entry {
            margin: 4px 0;
            font-size: 10px;
            border-bottom: 1px solid #21262d;
            padding-bottom: 4px;
        }

        .chat-query {
            color: #79c0ff;
            font-weight: bold;
        }

        .chat-response {
            color: #7d8590;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ECHO BRAIN CONSOLE</h1>
        <div class="status" id="system-time"></div>
    </div>

    <div class="container">
        <!-- Left Panel: Service Status & Quick Actions -->
        <div class="panel">
            <h2>Service Status</h2>
            <div class="content">
                <div id="service-status"></div>
                <button class="btn" onclick="checkServices()">Check All</button>
            </div>

            <h2>Model Status</h2>
            <div class="content">
                <div id="model-actions"></div>
                <button class="btn" onclick="refreshModelActions()">Refresh</button>
            </div>

            <h2>Memory Search</h2>
            <div class="content">
                <input type="text" class="search-box" id="memory-search" placeholder="Search vectors...">
                <button class="btn" onclick="searchMemory()">Search</button>
                <button class="btn" onclick="getFacts()">Facts</button>
                <div id="memory-results"></div>
            </div>
        </div>

        <!-- Center Panel: Live Logs & Chat History -->
        <div class="panel">
            <h2>Live System Logs & Activity</h2>
            <div class="main-content">
                <div class="log-viewer" id="system-logs" style="height: 350px; margin-bottom: 8px;"></div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn" onclick="refreshLogs()">Refresh Logs</button>
                    <button class="btn" onclick="clearLogs()">Clear</button>
                    <button class="btn" onclick="loadServiceLogs()">Service Logs</button>
                </div>
            </div>

            <h2>Echo Brain Activity & Recent Tasks</h2>
            <div class="main-content">
                <div class="chat-history" id="chat-history" style="height: 280px; margin-bottom: 8px;"></div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="loadChatHistory()">Refresh Chat</button>
                    <button class="btn" onclick="loadRecentTasks()">Recent Tasks</button>
                    <button class="btn" onclick="loadErrors()">Show Errors</button>
                </div>
            </div>
        </div>

        <!-- Right Panel: Pipeline & System Metrics -->
        <div class="panel">
            <h2>System Metrics</h2>
            <div class="content">
                <div id="system-metrics"></div>
                <button class="btn" onclick="refreshMetrics()">Refresh</button>
            </div>

            <h2>Training Pipeline</h2>
            <div class="content">
                <div id="training-pipeline"></div>
                <button class="btn" onclick="refreshPipeline()">Refresh</button>
            </div>

            <h2>Pending Approvals</h2>
            <div class="content">
                <div id="pending-approvals"></div>
                <button class="btn" onclick="refreshApprovals()">Refresh</button>
            </div>

            <h2>Quick Actions</h2>
            <div class="content">
                <button class="btn" onclick="restartEchoBrain()">Restart Echo Brain</button>
                <button class="btn" onclick="clearCache()">Clear Cache</button>
                <button class="btn" onclick="syncModels()">Sync Models</button>
            </div>
        </div>
    </div>

    <script>
        // Update system time
        function updateTime() {
            const now = new Date();
            document.getElementById('system-time').textContent = now.toLocaleString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Search Echo Brain memory
        async function searchMemory() {
            const query = document.getElementById('memory-search').value;
            if (!query.trim()) return;

            const resultsDiv = document.getElementById('memory-results');
            resultsDiv.innerHTML = '<div class="log-line info">Searching...</div>';

            try {
                const response = await fetch('/api/dashboard/mcp/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, limit: 5 })
                });

                const data = await response.json();
                const content = data.content?.[0]?.text || JSON.stringify(data);

                resultsDiv.innerHTML = `<div class="memory-result">${content.slice(0, 500)}...</div>`;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="log-line error">Error: ${error.message}</div>`;
            }
        }

        // Get facts from Echo Brain
        async function getFacts() {
            const query = document.getElementById('memory-search').value || 'general';
            const resultsDiv = document.getElementById('memory-results');

            try {
                const response = await fetch('/api/dashboard/mcp/facts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: query })
                });

                const data = await response.json();
                const content = data.content?.[0]?.text || JSON.stringify(data);

                resultsDiv.innerHTML = `<div class="memory-result">${content}</div>`;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="log-line error">Facts error: ${error.message}</div>`;
            }
        }

        // Load recent chat history from Echo Brain
        async function loadChatHistory() {
            const historyDiv = document.getElementById('chat-history');

            try {
                // Get recent conversations from echo brain
                const response = await fetch('/api/dashboard/mcp/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: 'claude conversation', limit: 10 })
                });

                const data = await response.json();
                const content = data.content?.[0]?.text || '';

                // Parse and display recent entries
                const lines = content.split('\n').slice(0, 20);
                historyDiv.innerHTML = lines.map(line =>
                    `<div class="chat-entry">
                        <div class="chat-query">${line.slice(0, 60)}...</div>
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                    </div>`
                ).join('');

            } catch (error) {
                historyDiv.innerHTML = `<div class="log-line error">Chat history error: ${error.message}</div>`;
            }
        }

        // Check service status
        async function checkServices() {
            const statusDiv = document.getElementById('service-status');

            try {
                const response = await fetch('/api/dashboard/services/status');
                const data = await response.json();

                let html = '';
                for (const service of data.services) {
                    html += `
                        <div class="service-item">
                            <span><span class="service-status ${service.status}"></span>${service.name}</span>
                            <span>:${service.port}</span>
                        </div>
                    `;
                }
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="log-line error">Service check error: ${error.message}</div>`;
            }
        }

        // Refresh system logs
        async function refreshLogs() {
            const logsDiv = document.getElementById('system-logs');

            try {
                const response = await fetch('/api/dashboard/logs/system');
                const data = await response.json();

                logsDiv.innerHTML = data.logs.map(log =>
                    `<div class="log-line ${log.level}">[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}</div>`
                ).join('');
            } catch (error) {
                logsDiv.innerHTML = `<div class="log-line error">[${new Date().toLocaleTimeString()}] Error loading logs: ${error.message}</div>`;
            }
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('system-logs').innerHTML = '';
        }

        // Refresh model actions
        async function refreshModelActions() {
            const actionsDiv = document.getElementById('model-actions');

            try {
                const response = await fetch('/api/dashboard/models/ollama');
                const data = await response.json();

                actionsDiv.innerHTML = data.models.slice(0, 8).map(model =>
                    `<div class="pipeline-item">
                        ${model.name}
                        <span class="pipeline-status complete">${model.size}</span>
                    </div>`
                ).join('');
            } catch (error) {
                actionsDiv.innerHTML = `<div class="log-line error">Model error: ${error.message}</div>`;
            }
        }

        // Refresh training pipeline
        async function refreshPipeline() {
            const pipelineDiv = document.getElementById('training-pipeline');

            try {
                const response = await fetch('/api/dashboard/pipeline/status');
                const data = await response.json();

                pipelineDiv.innerHTML = data.pipelines.map(pipeline =>
                    `<div class="pipeline-item">
                        ${pipeline.name}
                        <span class="pipeline-status ${pipeline.status}">${pipeline.progress}</span>
                    </div>`
                ).join('');
            } catch (error) {
                pipelineDiv.innerHTML = `<div class="log-line error">Pipeline error: ${error.message}</div>`;
            }
        }

        // Refresh pending approvals
        async function refreshApprovals() {
            const approvalsDiv = document.getElementById('pending-approvals');

            try {
                const response = await fetch('/api/dashboard/approvals/pending');
                const data = await response.json();

                approvalsDiv.innerHTML = data.approvals.map(approval =>
                    `<div class="approval-item ${approval.type}">
                        ${approval.task}
                        <div class="timestamp">${approval.time}</div>
                    </div>`
                ).join('');
            } catch (error) {
                approvalsDiv.innerHTML = `<div class="log-line error">Approvals error: ${error.message}</div>`;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkServices();
            refreshLogs();
            loadChatHistory();
            refreshModelActions();
            refreshPipeline();
            refreshApprovals();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                checkServices();
                refreshLogs();
            }, 30000);
        });

        // Auto-refresh chat history every 2 minutes
        setInterval(loadChatHistory, 120000);
    </script>
</body>
</html>