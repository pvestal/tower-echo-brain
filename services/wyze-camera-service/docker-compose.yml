version: '3.8'

services:
  wyze-bridge:
    image: mrlt8/wyze-bridge:latest
    ports:
      - "1935:1935"    # RTMP
      - "8554:8554"    # RTSP
      - "8888:8888"    # HLS
      - "5000:5000"    # Web UI
    environment:
      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}
      - API_ID=${WYZE_KEY_ID}
      - API_KEY=${WYZE_API_KEY}
      - WB_AUTH=false  # Disable web UI authentication for testing
      - TOTP_KEY=${WYZE_TOTP_KEY}
    volumes:
      - wyze_tokens:/tokens
    restart: unless-stopped
    networks:
      - tower-network

  wyze-camera-service:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8104:8104"
    environment:
      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}
      - WYZE_KEY_ID=${WYZE_KEY_ID}
      - WYZE_API_KEY=${WYZE_API_KEY}
      - WYZE_TOTP_KEY=${WYZE_TOTP_KEY}
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    depends_on:
      - wyze-bridge
    networks:
      - tower-network

  # Optional nginx proxy for serving static files
  nginx:
    image: nginx:alpine
    ports:
      - "8101:80"
    volumes:
      - ./index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - wyze-camera-service
    restart: unless-stopped
    networks:
      - tower-network

networks:
  tower-network:
    external: true

volumes:
  wyze_tokens: