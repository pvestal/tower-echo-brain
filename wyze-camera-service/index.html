<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyze Camera Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/wyze/favicon.ico">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900">
    <div id="app"></div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    cameras: [],
                    loading: true,
                    selectedCamera: null,
                    events: [],
                    serviceHealth: null,
                    refreshInterval: null,
                    liveStreamInterval: null,
                    currentSnapshot: null,
                    apiBaseUrl: '/api/wyze'  // Use Tower HTTPS proxy
                };
            },

            async mounted() {
                await this.loadServiceHealth();
                await this.loadCameras();
                this.startAutoRefresh();
            },

            beforeUnmount() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                if (this.liveStreamInterval) {
                    clearInterval(this.liveStreamInterval);
                }
            },

            methods: {
                async loadServiceHealth() {
                    try {
                        const response = await axios.get(`${this.apiBaseUrl}/health`);
                        this.serviceHealth = response.data;
                    } catch (error) {
                        console.error('Failed to load service health:', error);
                        this.serviceHealth = { status: 'error', wyze_connected: false };
                    }
                },

                async loadCameras() {
                    try {
                        this.loading = true;
                        const response = await axios.get(`${this.apiBaseUrl}/cameras`);

                        if (response.data.success) {
                            this.cameras = response.data.data.cameras;
                        } else {
                            throw new Error(response.data.error);
                        }
                    } catch (error) {
                        console.error('Failed to load cameras:', error);
                        this.showNotification('Failed to load cameras', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async selectCamera(camera) {
                    // Stop previous live stream if any
                    if (this.liveStreamInterval) {
                        clearInterval(this.liveStreamInterval);
                    }

                    this.selectedCamera = camera;
                    await this.loadCameraEvents(camera.mac);

                    // Start live stream for selected camera
                    if (camera.is_online) {
                        this.startLiveStream(camera.mac);
                    }
                },

                async loadCameraEvents(mac) {
                    try {
                        const response = await axios.get(`${this.apiBaseUrl}/cameras/${mac}/events`);
                        if (response.data.success) {
                            this.events = response.data.data.events;
                        }
                    } catch (error) {
                        console.error('Failed to load camera events:', error);
                    }
                },

                async toggleCameraPower(camera) {
                    try {
                        const response = await axios.post(`${this.apiBaseUrl}/cameras/power`, {
                            mac: camera.mac,
                            enabled: !camera.is_online
                        });

                        if (response.data.success) {
                            camera.is_online = !camera.is_online;
                            this.showNotification(
                                `Camera ${camera.nickname} ${camera.is_online ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        } else {
                            throw new Error(response.data.error);
                        }
                    } catch (error) {
                        console.error('Failed to toggle camera power:', error);
                        this.showNotification('Failed to toggle camera power', 'error');
                    }
                },

                async controlPTZ(mac, action) {
                    try {
                        const response = await axios.post(`${this.apiBaseUrl}/cameras/ptz`, {
                            mac: mac,
                            action: action
                        });

                        if (response.data.success) {
                            this.showNotification(`PTZ ${action} executed`, 'success');
                        } else {
                            throw new Error(response.data.error);
                        }
                    } catch (error) {
                        console.error('Failed to control PTZ:', error);
                        this.showNotification('Failed to control camera movement', 'error');
                    }
                },

                async toggleMotionDetection(mac, enabled) {
                    try {
                        const response = await axios.post(`${this.apiBaseUrl}/cameras/${mac}/motion?enabled=${enabled}`);

                        if (response.data.success) {
                            this.showNotification(
                                `Motion detection ${enabled ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        }
                    } catch (error) {
                        console.error('Failed to toggle motion detection:', error);
                        this.showNotification('Failed to toggle motion detection', 'error');
                    }
                },

                async toggleNightVision(mac, enabled) {
                    try {
                        const response = await axios.post(`${this.apiBaseUrl}/cameras/${mac}/night-vision?enabled=${enabled}`);

                        if (response.data.success) {
                            this.showNotification(
                                `Night vision ${enabled ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        }
                    } catch (error) {
                        console.error('Failed to toggle night vision:', error);
                        this.showNotification('Failed to toggle night vision', 'error');
                    }
                },

                async triggerSiren(mac) {
                    try {
                        const response = await axios.post(`${this.apiBaseUrl}/cameras/${mac}/siren`);

                        if (response.data.success) {
                            this.showNotification('Siren triggered', 'warning');
                        }
                    } catch (error) {
                        console.error('Failed to trigger siren:', error);
                        this.showNotification('Failed to trigger siren', 'error');
                    }
                },

                async stopSiren(mac) {
                    try {
                        const response = await axios.delete(`${this.apiBaseUrl}/cameras/${mac}/siren`);

                        if (response.data.success) {
                            this.showNotification('Siren stopped', 'success');
                        }
                    } catch (error) {
                        console.error('Failed to stop siren:', error);
                        this.showNotification('Failed to stop siren', 'error');
                    }
                },

                async refreshAuth() {
                    try {
                        const response = await axios.post(`${this.apiBaseUrl}/auth/refresh`);

                        if (response.data.success) {
                            this.showNotification('Authentication refreshed', 'success');
                            await this.loadServiceHealth();
                            await this.loadCameras();
                        }
                    } catch (error) {
                        console.error('Failed to refresh auth:', error);
                        this.showNotification('Failed to refresh authentication', 'error');
                    }
                },

                startAutoRefresh() {
                    this.refreshInterval = setInterval(async () => {
                        await this.loadServiceHealth();
                        if (this.serviceHealth?.wyze_connected) {
                            await this.loadCameras();
                        }
                    }, 30000); // Refresh every 30 seconds
                },

                showNotification(message, type = 'info') {
                    // Simple notification system
                    const notification = document.createElement('div');
                    const bgColor = {
                        success: 'bg-green-500',
                        error: 'bg-red-500',
                        warning: 'bg-yellow-500',
                        info: 'bg-blue-500'
                    }[type] || 'bg-blue-500';

                    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
                    notification.textContent = message;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                },

                formatTimestamp(timestamp) {
                    if (!timestamp) return 'Unknown';
                    return new Date(timestamp).toLocaleString();
                },

                startLiveStream(mac) {
                    // Update snapshot immediately
                    this.updateSnapshot(mac);

                    // Set up interval to refresh every 2 seconds for live effect
                    this.liveStreamInterval = setInterval(() => {
                        this.updateSnapshot(mac);
                    }, 2000);
                },

                async updateSnapshot(mac) {
                    try {
                        // Add timestamp to prevent caching
                        const timestamp = new Date().getTime();
                        this.currentSnapshot = `${this.apiBaseUrl}/cameras/${mac}/snapshot?t=${timestamp}`;
                    } catch (error) {
                        console.error('Failed to update snapshot:', error);
                    }
                },

                openLiveStream(mac) {
                    // Open live stream in new window/tab
                    const streamUrl = `${this.apiBaseUrl}/cameras/${mac}/stream`;
                    window.open(streamUrl, '_blank', 'width=1280,height=720');
                }
            },

            template: `
                <div class="min-h-screen bg-gray-900">
                    <!-- Header -->
                    <nav class="bg-gray-800 shadow-lg border-b border-gray-700">
                        <div class="max-w-7xl mx-auto px-4">
                            <div class="flex justify-between h-16">
                                <div class="flex items-center">
                                    <h1 class="text-xl font-semibold text-gray-100">
                                        <i class="fas fa-video text-blue-600 mr-2"></i>
                                        Wyze Camera Dashboard
                                    </h1>
                                </div>

                                <div class="flex items-center space-x-4">
                                    <!-- Service Status -->
                                    <div class="flex items-center">
                                        <div class="flex items-center space-x-2">
                                            <div :class="[
                                                'w-3 h-3 rounded-full',
                                                serviceHealth?.wyze_connected ? 'bg-green-500' : 'bg-red-500'
                                            ]"></div>
                                            <span class="text-sm text-gray-400">
                                                {{ serviceHealth?.status || 'Unknown' }}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Refresh Auth Button -->
                                    <button
                                        @click="refreshAuth"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                    >
                                        <i class="fas fa-sync-alt mr-1"></i>
                                        Refresh Auth
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto py-6 px-4">
                        <!-- Loading State -->
                        <div v-if="loading" class="flex justify-center items-center h-64">
                            <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
                        </div>

                        <!-- Main Content -->
                        <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Camera List -->
                            <div class="lg:col-span-1">
                                <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-gray-700">
                                    <h2 class="text-lg font-semibold text-gray-100 mb-4">
                                        Cameras ({{ cameras.length }})
                                    </h2>

                                    <div v-if="cameras.length === 0" class="text-center text-gray-400 py-8">
                                        <i class="fas fa-video-slash text-4xl mb-2"></i>
                                        <p>No cameras found</p>
                                    </div>

                                    <div v-else class="space-y-3">
                                        <div
                                            v-for="camera in cameras"
                                            :key="camera.mac"
                                            @click="selectCamera(camera)"
                                            :class="[
                                                'p-4 border rounded-lg cursor-pointer transition-all',
                                                selectedCamera?.mac === camera.mac
                                                    ? 'border-blue-500 bg-gray-700'
                                                    : 'border-gray-600 hover:border-gray-500'
                                            ]"
                                        >
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <h3 class="font-medium text-gray-100">{{ camera.nickname }}</h3>
                                                    <p class="text-sm text-gray-400">{{ camera.model }}</p>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <div :class="[
                                                        'w-3 h-3 rounded-full',
                                                        camera.is_online ? 'bg-green-500' : 'bg-red-500'
                                                    ]"></div>
                                                    <button
                                                        @click.stop="toggleCameraPower(camera)"
                                                        :class="[
                                                            'p-1 rounded text-xs',
                                                            camera.is_online
                                                                ? 'bg-red-100 text-red-600 hover:bg-red-200'
                                                                : 'bg-green-100 text-green-600 hover:bg-green-200'
                                                        ]"
                                                    >
                                                        <i :class="camera.is_online ? 'fas fa-power-off' : 'fas fa-play'"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Camera Details & Controls -->
                            <div class="lg:col-span-2">
                                <div v-if="!selectedCamera" class="bg-white rounded-lg shadow-md p-6">
                                    <div class="text-center text-gray-400 py-16">
                                        <i class="fas fa-video text-6xl mb-4"></i>
                                        <p class="text-xl">Select a camera to view controls</p>
                                    </div>
                                </div>

                                <div v-else class="space-y-6">
                                    <!-- Live Stream Preview -->
                                    <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-gray-700">
                                        <h2 class="text-xl font-semibold text-gray-100 mb-4">
                                            Live Feed - {{ selectedCamera.nickname }}
                                        </h2>

                                        <div class="bg-black rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
                                            <img v-if="selectedCamera.is_online && currentSnapshot"
                                                 :src="currentSnapshot"
                                                 :alt="selectedCamera.nickname"
                                                 class="w-full h-full object-cover cursor-pointer"
                                                 @click="openLiveStream(selectedCamera.mac)">
                                            <div v-else-if="selectedCamera.is_online && !currentSnapshot"
                                                 class="w-full h-full flex items-center justify-center text-gray-500">
                                                <i class="fas fa-spinner fa-spin text-6xl"></i>
                                                <p class="ml-4">Loading live stream...</p>
                                            </div>
                                            <div v-else class="w-full h-full flex items-center justify-center text-gray-500">
                                                <div class="text-center">
                                                    <i class="fas fa-video-slash text-6xl mb-2"></i>
                                                    <p>Camera Offline</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-2 text-center">
                                            <div v-if="selectedCamera.is_online" class="flex items-center justify-center space-x-4">
                                                <span class="text-green-400 flex items-center">
                                                    <i class="fas fa-circle text-xs mr-1 animate-pulse"></i>
                                                    Live Stream Active
                                                </span>
                                                <button @click="openLiveStream(selectedCamera.mac)"
                                                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                                    <i class="fas fa-expand mr-1"></i>Open Full Screen
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Camera Info -->
                                    <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-gray-700">
                                        <h2 class="text-xl font-semibold text-gray-100 mb-4">
                                            {{ selectedCamera.nickname }}
                                        </h2>

                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="font-medium text-gray-400">Model:</span>
                                                <span class="ml-2 text-gray-200">{{ selectedCamera.model }}</span>
                                            </div>
                                            <div>
                                                <span class="font-medium text-gray-400">Status:</span>
                                                <span :class="[
                                                    'ml-2 px-2 py-1 rounded text-xs',
                                                    selectedCamera.is_online
                                                        ? 'bg-green-100 text-green-800'
                                                        : 'bg-red-100 text-red-800'
                                                ]">
                                                    {{ selectedCamera.is_online ? 'Online' : 'Offline' }}
                                                </span>
                                            </div>
                                            <div v-if="selectedCamera.ip">
                                                <span class="font-medium text-gray-400">IP:</span>
                                                <span class="ml-2 text-gray-200">{{ selectedCamera.ip }}</span>
                                            </div>
                                            <div v-if="selectedCamera.firmware_ver">
                                                <span class="font-medium text-gray-400">Firmware:</span>
                                                <span class="ml-2 text-gray-200">{{ selectedCamera.firmware_ver }}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- PTZ Controls -->
                                    <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-gray-700">
                                        <h3 class="text-lg font-semibold text-gray-100 mb-4">PTZ Controls</h3>

                                        <div class="flex justify-center">
                                            <div class="grid grid-cols-3 gap-2 w-48">
                                                <div></div>
                                                <button
                                                    @click="controlPTZ(selectedCamera.mac, 'up')"
                                                    class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg"
                                                >
                                                    <i class="fas fa-chevron-up"></i>
                                                </button>
                                                <div></div>

                                                <button
                                                    @click="controlPTZ(selectedCamera.mac, 'left')"
                                                    class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg"
                                                >
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <button
                                                    @click="controlPTZ(selectedCamera.mac, 'reset')"
                                                    class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg text-xs"
                                                >
                                                    <i class="fas fa-home"></i>
                                                </button>
                                                <button
                                                    @click="controlPTZ(selectedCamera.mac, 'right')"
                                                    class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg"
                                                >
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>

                                                <div></div>
                                                <button
                                                    @click="controlPTZ(selectedCamera.mac, 'down')"
                                                    class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg"
                                                >
                                                    <i class="fas fa-chevron-down"></i>
                                                </button>
                                                <div></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Feature Controls -->
                                    <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-gray-700">
                                        <h3 class="text-lg font-semibold text-gray-100 mb-4">Camera Features</h3>

                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <button
                                                @click="toggleMotionDetection(selectedCamera.mac, true)"
                                                class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg text-sm font-medium"
                                            >
                                                <i class="fas fa-running mr-1"></i>
                                                Enable Motion
                                            </button>

                                            <button
                                                @click="toggleMotionDetection(selectedCamera.mac, false)"
                                                class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg text-sm font-medium"
                                            >
                                                <i class="fas fa-stop mr-1"></i>
                                                Disable Motion
                                            </button>

                                            <button
                                                @click="toggleNightVision(selectedCamera.mac, true)"
                                                class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg text-sm font-medium"
                                            >
                                                <i class="fas fa-moon mr-1"></i>
                                                Night Vision
                                            </button>

                                            <button
                                                @click="toggleNightVision(selectedCamera.mac, false)"
                                                class="bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-lg text-sm font-medium"
                                            >
                                                <i class="fas fa-sun mr-1"></i>
                                                Day Vision
                                            </button>
                                        </div>

                                        <!-- Siren Controls -->
                                        <div class="mt-4 pt-4 border-t border-gray-600">
                                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Siren</h4>
                                            <div class="flex space-x-2">
                                                <button
                                                    @click="triggerSiren(selectedCamera.mac)"
                                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                                >
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                                    Trigger Siren
                                                </button>

                                                <button
                                                    @click="stopSiren(selectedCamera.mac)"
                                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                                >
                                                    <i class="fas fa-stop mr-1"></i>
                                                    Stop Siren
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Recent Events -->
                                    <div class="bg-gray-800 rounded-lg shadow-md p-6 border border-gray-700">
                                        <h3 class="text-lg font-semibold text-gray-100 mb-4">Recent Events</h3>

                                        <div v-if="events.length === 0" class="text-center text-gray-400 py-8">
                                            <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                            <p>No recent events</p>
                                        </div>

                                        <div v-else class="space-y-3">
                                            <div
                                                v-for="event in events.slice(0, 5)"
                                                :key="event.event_id"
                                                class="flex items-center justify-between p-3 bg-gray-700 rounded-lg"
                                            >
                                                <div>
                                                    <p class="font-medium text-gray-100">{{ event.event_type }}</p>
                                                    <p class="text-sm text-gray-400">{{ formatTimestamp(event.timestamp) }}</p>
                                                </div>
                                                <div v-if="event.thumbnail">
                                                    <img
                                                        :src="event.thumbnail"
                                                        alt="Event thumbnail"
                                                        class="w-16 h-12 object-cover rounded"
                                                    >
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        }).mount('#app');
    </script>
</body>
</html>