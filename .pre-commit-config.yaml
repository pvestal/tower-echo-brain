# Pre-commit Configuration for Echo Brain Board of Directors
# Production-grade code quality enforcement

repos:
  # ============================================================================
  # Core Pre-commit Hooks
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--unsafe]
      - id: check-json
      - id: check-toml
      - id: check-xml
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-case-conflict
      - id: check-merge-conflict
      - id: check-executables-have-shebangs
      - id: check-shebang-scripts-are-executable
      - id: detect-private-key
      - id: detect-aws-credentials
      - id: mixed-line-ending
        args: [--fix=lf]
      - id: name-tests-test
        args: [--pytest-test-first]
      - id: requirements-txt-fixer

  # ============================================================================
  # Python Code Formatting
  # ============================================================================
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        name: Format Python code with Black
        args: [--line-length=100]
        language_version: python3

  # ============================================================================
  # Import Sorting
  # ============================================================================
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: Sort Python imports with isort
        args:
          - --profile=black
          - --line-length=100
          - --multi-line=3
          - --trailing-comma
          - --force-grid-wrap=0
          - --combine-as
          - --use-parentheses

  # ============================================================================
  # Code Quality and Linting
  # ============================================================================
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: Lint Python code with Flake8
        args:
          - --max-line-length=100
          - --extend-ignore=E203,W503,E501
          - --per-file-ignores=__init__.py:F401
          - --count
          - --statistics
        additional_dependencies:
          - flake8-docstrings
          - flake8-import-order
          - flake8-bugbear
          - flake8-comprehensions
          - flake8-simplify

  # ============================================================================
  # Type Checking
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: Type check Python code with MyPy
        args:
          - --ignore-missing-imports
          - --no-strict-optional
          - --warn-redundant-casts
          - --warn-unused-ignores
          - --warn-unreachable
        additional_dependencies:
          - types-requests
          - types-PyYAML
          - types-redis
        exclude: ^(tests/|migrations/)

  # ============================================================================
  # Security Scanning
  # ============================================================================
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        name: Security scan Python code with Bandit
        args:
          - --configfile=pyproject.toml
          - --severity-level=medium
          - --confidence-level=medium
        exclude: ^tests/

  # ============================================================================
  # Dependency Security
  # ============================================================================
  - repo: https://github.com/pyupio/safety
    rev: 3.0.1
    hooks:
      - id: safety
        name: Check dependencies for security vulnerabilities
        args:
          - --full-report
          - --ignore=70612  # Example: ignore specific vulnerability if needed

  # ============================================================================
  # Documentation Quality
  # ============================================================================
  - repo: https://github.com/pycqa/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        name: Check Python docstring style
        args:
          - --convention=google
          - --add-ignore=D100,D101,D102,D103,D104,D105,D106,D107
        exclude: ^(tests/|migrations/)

  # ============================================================================
  # Secrets Detection
  # ============================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        name: Detect secrets in code
        args:
          - --baseline=.secrets.baseline
          - --exclude-files=.*\.git/.*
          - --exclude-files=.*node_modules/.*
          - --exclude-files=.*\.pytest_cache/.*
          - --exclude-files=.*__pycache__/.*

  # ============================================================================
  # SQL Quality (if applicable)
  # ============================================================================
  - repo: https://github.com/sqlfluff/sqlfluff
    rev: 3.0.2
    hooks:
      - id: sqlfluff-lint
        name: Lint SQL files
        files: \.sql$
        args: [--dialect=postgres]
      - id: sqlfluff-fix
        name: Fix SQL files
        files: \.sql$
        args: [--dialect=postgres]

  # ============================================================================
  # Dockerfile Linting
  # ============================================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint-docker
        name: Lint Dockerfiles
        files: Dockerfile.*

  # ============================================================================
  # YAML/JSON Formatting
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: Format YAML, JSON, and Markdown files
        types_or: [yaml, json, markdown]
        args: [--prose-wrap=always, --print-width=100]

  # ============================================================================
  # Local Hooks for Custom Checks
  # ============================================================================
  - repo: local
    hooks:
      # Test Coverage Check
      - id: test-coverage
        name: Check test coverage is above threshold
        entry: bash -c 'if [ -f .coverage ]; then coverage report --fail-under=80; else echo "No coverage data found, running tests..."; make test-fast; coverage report --fail-under=80; fi'
        language: system
        pass_filenames: false
        stages: [pre-push]

      # Run Fast Tests
      - id: run-tests
        name: Run fast test suite
        entry: make test-fast
        language: system
        pass_filenames: false
        stages: [pre-push]

      # Check for Debug Statements
      - id: check-debug-statements
        name: Check for debug statements
        entry: bash -c 'if grep -r "pdb.set_trace\|debugger\|console.log\|print(" --include="*.py" --include="*.js" --exclude-dir=tests .; then echo "Debug statements found!"; exit 1; fi'
        language: system
        pass_filenames: false

      # Check for TODO/FIXME without tickets
      - id: check-todos
        name: Check for untracked TODOs
        entry: bash -c 'if grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.py" --include="*.js" --exclude-dir=tests . | grep -v "TODO.*#[0-9]"; then echo "Untracked TODOs found! Please add ticket numbers."; exit 1; fi'
        language: system
        pass_filenames: false

      # Validate Configuration Files
      - id: validate-configs
        name: Validate configuration files
        entry: make validate-config
        language: system
        pass_filenames: false

      # Check Database Migrations (if applicable)
      - id: check-migrations
        name: Check database migrations
        entry: bash -c 'if [ -d migrations ] && [ -n "$(git diff --cached --name-only migrations/)" ]; then echo "Database migration detected. Ensure proper review."; fi'
        language: system
        pass_filenames: false

      # License Header Check
      - id: license-header
        name: Check license headers
        entry: bash -c 'find . -name "*.py" -not -path "./tests/*" -not -path "./venv/*" -not -path "./.git/*" -exec grep -L "Author:\|Copyright\|License" {} \; | head -5 | while read file; do echo "Missing license header: $file"; done'
        language: system
        pass_filenames: false

      # File Size Check
      - id: check-file-size
        name: Check file sizes
        entry: bash -c 'find . -name "*.py" -size +1000k -not -path "./venv/*" -not -path "./.git/*" | while read file; do echo "Large file detected: $file"; done'
        language: system
        pass_filenames: false

# ============================================================================
# Configuration
# ============================================================================
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false

default_stages: [commit, push]
fail_fast: false
minimum_pre_commit_version: 3.6.0

# ============================================================================
# Hook-specific Configuration
# ============================================================================
exclude: |
  (?x)^(
    .*\.git/.*|
    .*node_modules/.*|
    .*\.pytest_cache/.*|
    .*__pycache__/.*|
    .*\.venv/.*|
    .*venv/.*|
    .*\.egg-info/.*|
    .*\.coverage|
    .*\.DS_Store|
    .*\.env.*|
    .*archive-.*/.*|
    .*backup-.*/.*
  )$