name: Memory System Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-memory:
    name: Test Memory System
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary

      - name: Test Python Import
        run: |
          python -c "
          import psycopg2.extras
          from psycopg2.extras import Json
          print('✅ psycopg2.extras imports successfully')
          test = Json({'test': 'data'})
          print('✅ Json wrapper works')
          "

      - name: Verify Database File Changes
        run: |
          echo "Checking database.py..."

          if [ ! -f "src/db/database.py" ]; then
              echo "❌ src/db/database.py not found"
              exit 1
          fi

          echo "✅ database.py exists"

          # Show what we're checking
          echo ""
          echo "Checking for psycopg2.extras import..."
          if grep -q "^import psycopg2.extras" src/db/database.py; then
              echo "✅ Import found"
          else
              echo "⚠️ Checking alternative import pattern..."
              if grep -q "psycopg2.extras" src/db/database.py; then
                  echo "✅ psycopg2.extras usage found"
              else
                  echo "❌ No psycopg2.extras found"
                  echo "First 20 lines of database.py:"
                  head -20 src/db/database.py
                  exit 1
              fi
          fi

          echo ""
          echo "Checking for JSONB fix..."
          if grep -q "psycopg2.extras.Json" src/db/database.py; then
              count=$(grep -c "psycopg2.extras.Json" src/db/database.py)
              echo "✅ JSONB fix found ($count occurrences)"
              echo "Sample usage:"
              grep "psycopg2.extras.Json" src/db/database.py | head -1
          else
              echo "❌ JSONB fix not found"
              echo "Checking for json.dumps instead:"
              grep "json.dumps" src/db/database.py | head -3
              exit 1
          fi

          echo ""
          echo "Checking port configuration..."
          if grep -q "5433" src/db/database.py; then
              echo "❌ Old port 5433 still exists:"
              grep -n "5433" src/db/database.py
              exit 1
          else
              echo "✅ No port 5433 found (correct)"
          fi

          echo ""
          echo "=== All checks passed ==="

      - name: Summary
        run: |
          echo "✅ Memory System Changes Verified"
          echo "- psycopg2.extras import: ✓"
          echo "- JSONB handling fixed: ✓"
          echo "- Port configuration correct: ✓"